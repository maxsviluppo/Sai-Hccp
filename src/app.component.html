@if (!state.isLoggedIn()) {
<!-- Login / Demo Selection Screen -->
<div class="min-h-screen flex items-center justify-center bg-slate-50 p-4 relative overflow-y-auto">
  <!-- Background Decor -->
  <div
    class="absolute top-0 left-0 w-full h-96 bg-gradient-to-br from-emerald-600 to-teal-900 z-0 rounded-b-[50px] shadow-2xl">
  </div>

  <div
    class="relative z-10 w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[500px]">

    <!-- Left: Branding -->
    <div
      class="p-10 bg-slate-900 text-white flex flex-col justify-between items-center text-center relative overflow-hidden">
      <!-- Decor Circles -->
      <div
        class="absolute top-0 left-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2">
      </div>
      <div
        class="absolute bottom-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl translate-x-1/2 translate-y-1/2">
      </div>

      <div class="relative z-10 flex flex-col items-center">
        <img src="assets/logo.png?v=2" class="w-32 h-32 mb-6 drop-shadow-2xl animate-fade-in">
        <h1 class="text-3xl font-bold tracking-tight mb-2">HACCP Pro</h1>
        <p class="text-slate-400 text-sm font-medium tracking-widest uppercase">Enterprise Solution</p>
      </div>

      <div class="relative z-10 mt-8">
        <p class="text-slate-300 text-sm leading-relaxed max-w-xs mx-auto">
          La piattaforma integrata per la gestione della sicurezza alimentare, igiene e conformità normativa.
        </p>
      </div>

      <div class="relative z-10 text-xs text-slate-500 mt-8">
        &copy; 2026 HACCP Pro System
      </div>
    </div>

    <!-- Right: Login Logic -->
    <div class="p-10 flex flex-col justify-center bg-white relative">

      @if (loginMode() === 'SELECT') {
      <h2 class="text-2xl font-bold text-slate-900 mb-2">Benvenuto</h2>
      <p class="text-slate-500 mb-8 text-sm">Seleziona la modalità di accesso.</p>

      <div class="space-y-4">
        <button (click)="setLoginMode('ADMIN')"
          class="w-full text-left p-4 rounded-xl border border-slate-200 hover:border-blue-600 hover:bg-blue-50 transition-all group flex items-center gap-4 shadow-sm hover:shadow-md">
          <div
            class="w-12 h-12 rounded-full bg-blue-100/50 flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
            <i class="fa-solid fa-user-shield text-xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-slate-800 group-hover:text-blue-700">Accesso Amministrazione</h3>
            <p class="text-xs text-slate-500 mt-1">Gestione sedi, configurazioni e utenti.</p>
          </div>
          <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-blue-500"></i>
        </button>

        <button (click)="setLoginMode('OPERATOR')"
          class="w-full text-left p-4 rounded-xl border border-slate-200 hover:border-emerald-600 hover:bg-emerald-50 transition-all group flex items-center gap-4 shadow-sm hover:shadow-md">
          <div
            class="w-12 h-12 rounded-full bg-emerald-100/50 flex items-center justify-center text-emerald-600 group-hover:scale-110 transition-transform">
            <i class="fa-solid fa-users-gear text-xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-slate-800 group-hover:text-emerald-600">Accesso Operatore</h3>
            <p class="text-xs text-slate-500 mt-1">Compilazione checklist e registri.</p>
          </div>
          <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-emerald-500"></i>
        </button>
      </div>
      } @else {
      <!-- Login Form -->
      <button (click)="setLoginMode('SELECT')"
        class="absolute top-6 left-6 text-slate-400 hover:text-slate-600 flex items-center gap-2 text-sm font-medium transition-colors">
        <i class="fa-solid fa-chevron-left"></i> Indietro
      </button>

      <div class="mt-8 animate-fade-in-up">
        <h2 class="text-2xl font-bold text-slate-900 mb-1">
          @if(loginMode() === 'ADMIN') { Area Amministrativa } @else { Area Operativa }
        </h2>
        <p class="text-slate-500 mb-6 text-sm">Inserisci le tue credenziali per accedere.</p>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Nome Utente</label>
            <div class="relative">
              <i class="fa-solid fa-user absolute left-3 top-3 text-slate-400"></i>
              <input type="text" [value]="loginUsername()" (input)="loginUsername.set($any($event.target).value)"
                (keyup.enter)="doLogin()"
                class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                placeholder="Username">
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Password</label>
            <div class="relative">
              <i class="fa-solid fa-lock absolute left-3 top-3 text-slate-400"></i>
              <input type="password" [value]="loginPassword()" (input)="loginPassword.set($any($event.target).value)"
                (keyup.enter)="doLogin()"
                class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                placeholder="••••••••">
            </div>
          </div>

          @if (loginError()) {
          <div class="p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2 animate-shake">
            <i class="fa-solid fa-circle-exclamation"></i>
            Credenziali non valide. Riprova.
          </div>
          }

          <button (click)="doLogin()"
            class="w-full py-3 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-all shadow-lg shadow-slate-200 mt-4">
            ACCEDI
          </button>
        </div>
      </div>
      }

    </div>

  </div>
</div>
} @else {
<!-- Main App Shell -->
<div class="flex h-screen bg-slate-50 relative overflow-hidden">

  <!-- Mobile Sidebar Backdrop -->
  @if (isMobileMenuOpen()) {
  <div (click)="toggleMobileMenu()"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-40 md:hidden animate-fade-in"></div>
  }

  <!-- Sidebar -->
  <aside
    [class]="'w-72 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col border-r border-slate-800 fixed md:relative h-full z-50 transition-transform duration-300 md:translate-x-0 ' + (isMobileMenuOpen() ? 'translate-x-0' : '-translate-x-full')">
    <!-- Logo Area -->
    <div class="p-6 flex items-center gap-4 border-b border-slate-700/50">
      <div
        class="relative w-12 h-12 flex items-center justify-center bg-white rounded-xl shadow-lg overflow-hidden shrink-0">
        <img src="/logo.png" class="w-full h-full object-contain p-1.5">
      </div>
      <div class="overflow-hidden">
        <h1 class="text-white font-bold tracking-tight text-lg leading-tight truncate">HACCP Pro</h1>
        <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mt-0.5 truncate">Enterprise Solution
        </p>
      </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1 custom-scrollbar">
      @for (item of visibleMenuItems(); track item.id; let idx = $index) {

      <!-- Category Header -->
      @if (idx === 0 || item.category !== visibleMenuItems()[idx-1].category) {
      <div class="mt-8 mb-3 px-3 text-[10px] font-black text-slate-500 uppercase tracking-widest text-left">
        {{ getCategoryLabel(item.category) }}
      </div>
      }

      <button (click)="state.setModule(item.id); isMobileMenuOpen.set(false)" [class]="'w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group relative overflow-hidden justify-start text-left ' + 
        (state.currentModuleId() === item.id 
          ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg shadow-blue-500/30' 
          : 'text-slate-400 hover:bg-slate-800 hover:text-white')">

        <i
          [class]="'fa-solid text-lg w-6 text-left ' + item.icon + ' ' + (state.currentModuleId() === item.id ? 'text-white' : 'text-slate-500 group-hover:text-white')"></i>
        <span class="font-medium text-sm tracking-wide flex-1">{{ item.label }}</span>

        @if (state.currentModuleId() === item.id) {
        <i class="fa-solid fa-chevron-right text-[10px] opacity-70"></i>
        }
      </button>
      }
    </nav>

    <!-- User Profile Summary (Sidebar Footer) -->
    <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
      <button (click)="state.logout()"
        class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-500/10 hover:text-red-400 text-slate-400 transition-colors group">
        <div class="relative">
          <img [src]="state.currentUser()?.avatar"
            class="w-9 h-9 rounded-full border-2 border-slate-700 group-hover:border-red-400/50 transition-colors">
          <div class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full"></div>
        </div>
        <div class="text-left flex-1 min-w-0">
          <div class="font-bold text-xs truncate text-white">{{ state.currentUser()?.name }}</div>
          <div class="text-[10px] truncate opacity-60">Disconnetti</div>
        </div>
        <i class="fa-solid fa-power-off text-xs opacity-40 group-hover:opacity-100 transition-opacity"></i>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
    <!-- Mobile Toggle Bar -->
    <header
      class="h-16 bg-white border-b border-slate-200 flex md:hidden items-center justify-between px-4 z-40 flex-shrink-0">
      <div class="flex items-center gap-3">
        <img src="/logo.png" class="w-8 h-8 object-contain">
        <span class="font-bold text-slate-900 tracking-tight">HACCP Pro</span>
      </div>
      <button (click)="toggleMobileMenu()" class="text-slate-500 p-2 hover:bg-slate-100 rounded-lg transition-colors">
        <i class="fa-solid fa-bars-staggered text-xl"></i>
      </button>
    </header>

    <!-- Top Header (Desktop) -->
    <header
      class="bg-white/95 backdrop-blur-md border-b border-slate-200 h-16 hidden md:flex items-center justify-between px-8 sticky top-0 z-20 flex-shrink-0">
      <!-- Left: Page Title -->
      <div class="flex items-center gap-4">
        <h2 class="text-lg font-bold text-slate-800 tracking-tight">
          {{ getDataboardTitle() }}
        </h2>
      </div>

      <!-- Right: Global Filters + Notifications -->
      <div class="flex items-center gap-6">
        <!-- Notification Bell -->
        <button (click)="state.setModule('messages')"
          class="relative p-2 hover:bg-slate-100 rounded-xl transition-all group">
          <i class="fa-solid fa-bell text-slate-600 text-xl group-hover:text-blue-600 transition-colors"></i>
          @if (state.unreadMessagesCount() > 0) {
          <span
            class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center shadow-lg animate-pulse">
            {{ state.unreadMessagesCount() }}
          </span>
          }
        </button>

        <!-- Date Filter -->
        <div
          class="flex items-center bg-slate-50 rounded-xl border border-slate-200 px-4 py-2 hover:border-slate-300 transition-colors cursor-pointer group">
          <i class="fa-solid fa-calendar-alt text-slate-400 text-sm mr-3 group-hover:text-blue-500"></i>
          <input type="date" [value]="state.filterDate()" (change)="state.setDateFilter($any($event.target).value)"
            class="bg-transparent text-sm text-slate-700 font-semibold focus:outline-none cursor-pointer border-none p-0 outline-none">
        </div>

        <!-- Collaborator Filter (Context Switcher) -->
        <!-- Collaborator Filter (Context Switcher) - ADMIN ONLY -->
        @if (state.isAdmin()) {
        <div
          class="flex items-center bg-slate-50 rounded-xl border border-slate-200 px-4 py-2 hover:border-slate-300 transition-colors cursor-pointer group"
          [class.border-orange-300]="!state.isContextEditable()" [class.bg-orange-50]="!state.isContextEditable()">

          <i class="fa-solid fa-building-user text-slate-400 text-sm mr-3 group-hover:text-emerald-500"
            [class.text-orange-400]="!state.isContextEditable()"></i>

          <select [value]="state.filterCollaboratorId()"
            (change)="state.setCollaboratorFilter($any($event.target).value)"
            class="bg-transparent text-sm text-slate-700 font-semibold focus:outline-none cursor-pointer border-none p-0 outline-none pr-4 min-w-[200px]"
            [class.text-orange-800]="!state.isContextEditable()">
            <option value="">-- Seleziona Unità Operativa --</option>
            @for (user of contextUsers(); track user.id) {
            <option [value]="user.id">{{ user.displayName }}</option>
            }
          </select>
        </div>
        } @else {
        <!-- Operator: Static Context Display -->
        <div
          class="flex items-center px-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-slate-600 font-medium text-sm">
          <i class="fa-solid fa-user-tag text-slate-400 mr-2"></i>
          {{ state.currentUser()?.name }} <span class="mx-2 text-slate-300">|</span> {{ state.companyConfig().name }}
        </div>
        }

        @if (state.isAdmin() && !state.isContextEditable()) {
        <div
          class="hidden xl:flex items-center px-3 py-1 bg-slate-100 rounded text-[10px] font-bold text-slate-400 uppercase tracking-wider border border-slate-200"
          title="Seleziona un'unità per modificare i dati">
          <i class="fa-solid fa-lock mr-2"></i> Sola Lettura
        </div>
        }
      </div>
    </header>

    <!-- Scrollable Area -->
    <div class="flex-1 overflow-auto p-4 md:p-8 bg-slate-50 relative">
      <div class="max-w-7xl mx-auto pb-10">

        <!-- Dynamic Content Loading -->
        @switch (state.currentModuleId()) {
        @case ('dashboard') { <app-dashboard-view /> }
        @case ('reports') { <app-reports-view /> }
        @case ('general-checks') { <app-general-checks-view /> }
        @case ('operational-checklist') { <app-operational-checklist /> }
        @case ('staff-training') { <app-staff-training-checklist /> }
        @case ('suppliers') { <app-suppliers-view /> }
        @case ('products-cleaning') { <app-cleaning-products-view /> }
        @case ('equipment') { <app-equipment-view /> }
        @case ('allergens-ue1169') { <app-allergens-config-view /> }
        @case ('cleaning-maintenance') { <app-cleaning-maintenance-view /> }
        @case ('goods-receipt') { <app-goods-receipt-view /> }
        @case ('food-conservation') { <app-food-conservation-view /> }
        @case ('temperatures') { <app-temperatures-view /> }
        @case ('traceability') { <app-traceability-view /> }
        @case ('pest-control') { <app-pest-control-view /> }
        @case ('micro-bio') { <app-microbio-monitor-view /> }
        @case ('staff-hygiene') { <app-staff-hygiene-view /> }
        @case ('non-compliance') { <app-non-compliance-view /> }
        @case ('settings') { <app-settings-view /> }
        @case ('collaborators') { <app-collaborators-view /> }
        @case ('messages') { <app-messages-view /> }
        @case ('accounting') { <app-accounting-view /> }
        @default {
        <app-generic-module [moduleId]="state.currentModuleId()" />
        }
        }

      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <app-toast-container />
</div>
}